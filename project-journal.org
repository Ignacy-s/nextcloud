Need to setup my own Nextcloud/Owncloud instance for wedding
pictures.
* DONE Choosing what to install - Nextcloud has ~20k stars on Github, Owncloud - ~7.5k. Choosing Nextcloud
  CLOSED: [2022-07-04 Mon 09:17]
* DONE Choosing how to install.
  CLOSED: [2022-07-04 Mon 09:17]
** Using Nextcloud docker image.
* DONE Local demo without compose - just the Nextcloud container.
  CLOSED: [2022-07-04 Mon 09:16]
** Found installation instructions in the manual, but why bother. Better use docker images.
** Deciding not to over complicate implementation for now and leave all the bells and whistles ideas as  extr
** For starter managed to access web server on vagrant machine from friends mobile phone. (Re-started container in bridged network mode and found it's ip address).
*** Had some issues at first, but then realized that friend is not connected to my hotspot.
* DONE Local demo with docker-compose, multiple containers, but without proper secrets handling.
  CLOSED: [2022-07-04 Mon 23:52]
** Using the docker compose file from image's documentation (that can be found in this document under 'Feature Ideas>Use docker compose').
** Had to download docker-compose. Started the service by running 'docker-compose -d up' in the directory where I pasted the compose.yml file. It works as intended.

* DONE Running a Traefik tutorial from [[https://doc.traefik.io/traefik/getting-started/quick-start/][here]]. Still have notes from the last time I used Traefik, but it has been a while and it's just about creating some docker-compose files.
  CLOSED: [2022-07-08 Fri 02:38]
*** First docker compose from quickstart tutorial.
#+BEGIN_SRC ruby
version: '3'

services:
  reverse-proxy:
    # The official v2 Traefik docker image
    image: traefik:v2.7
    # Enables the web UI and tells Traefik to listen to docker
    command: --api.insecure=true --providers.docker
    ports:
      # The HTTP port
      - "80:80"
      # The Web UI (enabled by --api.insecure=true)
      - "8080:8080"
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock
#+END_SRC
**** Adding whoami service:
#+BEGIN_SRC ruby
  whoami:
    # A container that exposes an API to show its IP address
    image: traefik/whoami
    labels:
      - "traefik.http.routers.whoami.rule=Host(`whoami.docker.localhost`)"
#+END_SRC
**** Scaled up with 'docker-compose up -d --scale whoami=2' and can see how service is load balanced with 'curl -H Host:whoami.docker.localhost http://127.0.0.1' showing different machines.
** As I understand, Traefik doesn't change much in how the system's docker-compose file will be made. It's just another container to be run along others. And the other containers need an extra rubric in docker-compose file with labels to be read by Traefik.
* DONE Learning up on DNS in Docker from [[https://web.archive.org/web/20210724052518/https://kerneltalks.com/networking/how-docker-container-dns-works/][blog article on wayback machine]].
  CLOSED: [2022-07-08 Fri 02:38]
* DONE Getting a domain with Cloud Flare.
  CLOSED: [2022-07-08 Fri 02:42]
* DONE Reading up on how to use secrets with docker compose. Mentioning some sites:
  CLOSED: [2022-07-08 Fri 03:57]
** [[https://www.rockyourcode.com/using-docker-secrets-with-docker-compose/]]
*** For a local setup we can use files containing the secrets.
*** For production need to use docker swarm to declare secrets on a different node.
* TODO Local demo with docker-compose, traefik and portainer alongside, defining a network. Based on edited compose file from previous class.
** Writing a new docker-compose file based on examples from Docker Masterclass, Panda DevOps and Traefik Quickstart tutorial.
*** After defining the network, adding traefik container, nextcloud container and db for nextcloud.
#+BEGIN_SRC bash
version : '3'
# Defining a personal Nextcloud server with Traefik and Portainer

services:
  traefik-proxy:
    # Handles TLS certs and http to https redirection
    image: traefik:2.8
    restart: always
    container_name: traefik
    command:
      # Enables the web UI
      - "--api.insecure=true"
      # Declares cooperation with docker
      - "--providers.docker"
      ports:
        - "80:80"
        # For Web UI enabled by 'api-insecure'
        - "8080:8080"
      volumes:
        # Enables docker cooperation
        - "/var/run/docker.sock:/var/run/docker.sock:ro"

  nextcloud:
    image: nextcloud
    restart: always
    depends_on:
      - traefik-proxy
      - db-next
    volumes:
      - nextcloud:/var/www/html
    environment:
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=db
      
    networks:
      - nextcloud_db_network
      
  db-next:
    image: mariadb
    restart: always
    command:
      - --transaction-isolation=READ-COMMITTED
      - --binlog-format=ROW
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    depends_on:
      - traefik-proxy
    networks:
      - nextcloud_db_network
              



networks:
  nextcloud_db_network:
    driver: bridge
#+END_SRC
*** DONE Add volumes
    CLOSED: [2022-07-08 Fri 17:42]
#+BEGIN_SRC bash
version : '3'
# Defining a personal Nextcloud server with Traefik and Portainer

services:
  traefik-proxy:
    # Handles TLS certs and http to https redirection
    image: traefik:2.8
    restart: always
    container_name: traefik
    command:
      # Enables the web UI
      - "--api.insecure=true"
      # Declares cooperation with docker
      - "--providers.docker"
      # Defines entry for regular http traffic.
      - "--entryPoints.web.address=:80"
      # Redirects http to https
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # Defines https entry
      - "--entryPoints.websecure.address=:443"
      

    ports:
      - "80:80"
      # For Web UI enabled by 'api-insecure'
      - "8080:8080"
    volumes:
      # Enables docker cooperation
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

  nextcloud:
    image: nextcloud
    restart: always
    depends_on:
      - traefik-proxy
      - db-next
    volumes:
      - nextcloud:/var/www/html
    environment:
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=db

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.localhost`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
    networks:
      - nextcloud_db_network
      
  db-next:
    image: mariadb
    restart: always
    command:
      - --transaction-isolation=READ-COMMITTED
      - --binlog-format=ROW
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    depends_on:
      - traefik-proxy
    networks:
      - nextcloud_db_network

networks:
  nextcloud_db_network:
    driver: bridge

volumes:
  nextcloud:
  db:
#+END_SRC
**** TODO See if it runs.
***** Doesn't run - trying with a simpler setup.
***** Got the quickstart demo to run. Had to modify a HTTP Header.
http headers are sent along with the http request. They have to be
changed if we connect with a host behind traefik. Before I used curl
to get it to run. Defining headers in curl is easy:
curl -H Host:whoami.docker.localhost http://127.0.0.1

For use with Firefox and connecting from a different machine on the
same local network, we need to modify the Host header in the
browser. Tried 3 extensions, third worked for me. [[https://mybrowseraddon.com/modify-header-value.html][Modify Header Value
(HTTP Headers)]]
***** Trying to use the same Firefox Extension to modify header.
****** Opening traefik dashboard to find out what to put in the Host header.
it's under IP_ADDRESS:8080/dashboard
***** Something was wrong, so I added the whoami container to the nextcloud docker-compose. Whoami was working (pointing at the http://192.168.1.187/ with Host('whoami.docker.localhost')).
***** Spent lot of time trying to have nextcloud work the same way (just changing part of the host header to Host('nextcloud.docker.localhost').
***** Found the error, when scrolled up the screen. There was an orphan container when I removed whoami from docker-compose file.
***** DONE Working with limited functionality - kept removing things from the docker-compose.
      CLOSED: [2022-07-08 Fri 19:58]
****** docker-compose atm:

#+BEGIN_SRC yaml
version : '3'
# Defining a personal Nextcloud server with Traefik and Portainer

services:
  traefik-proxy:
    # Handles TLS certs and http to https redirection
    image: traefik:2.8
    restart: always
    container_name: traefik
    command:
      # Enables the web UI
      - "--api.insecure=true"
      # Declares cooperation with docker
      - "--providers.docker"
      # Defines entry for regular http traffic.
      - "--entryPoints.web.address=:80"
      # Redirects http to https
#      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
#      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # Defines https entry
      - "--entryPoints.websecure.address=:443"
      - "--providers.docker.exposedbydefault=false"
      - "--log.level=DEBUG"
    ports:
      - "80:80"
      # For Web UI enabled by 'api-insecure'
      - "8080:8080"
      - "443:443"
    volumes:
      # Enables docker cooperation
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

  nextcloud:
    image: nextcloud
    restart: always
    container_name: nextcloud
    depends_on:
      - traefik-proxy
      - db-next
    volumes:
      - nextcloud:/var/www/html
    environment:
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=db

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.docker.localhost`)"
      # - "traefik.http.routers.nextcloud.entrypoints=websecure"
      # - "traefik.http.routers.nextcloud.entrypoints=web"
    # networks:
    #   - nextcloud_db_network
      
  # Putting a whoami container to check if it will work.
  
  # whoami:
  #   # A container that exposes an API to show its IP address
  #   image: traefik/whoami
  #   container_name: whoami
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.whoami.rule=Host(`whoami.docker.localhost`)"
  #     # - "traefik.http.routers.nextcloud.entrypoints=websecure"
  #     # - "traefik.http.routers.nextcloud.entrypoints=web"


  db-next:
    image: mariadb
    restart: always
    command:
      - --transaction-isolation=READ-COMMITTED
      - --binlog-format=ROW
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    depends_on:
      - traefik-proxy
    networks:
      - nextcloud_db_network

networks:
  nextcloud_db_network:
    driver: bridge

volumes:
  nextcloud:
  db:
#+END_SRC

***** Uncomment things in docker-compose and see what happens. - It's the network defined in docker-compose that caused problems.
***** Need to learn how to connect nextcloud container with the database container using traefik.

*** [[https://duckduckgo.com/?q=traefik+example+connect+app+and+database+containers&t=ffab&ia=web][Search for the docs]] resulted with an interesting find - example traefik/portainer/compose setup in a [[https://rafrasenberg.com/posts/docker-container-management-with-traefik-v2-and-portainer/][blog article]].
*** TODO Connect app and db containers using Traefik.
**** DONE Downloading project files from Raf's (blog author) Github repo.
CLOSED: [2022-07-15 Fri 23:20]
#+BEGIN_SRC bash
  mkdir /vagrant/nextcloud-raf-local
  cd !$
  curl -L \ https://github.com/rafrasenberg/docker-traefik-portainer/archive/master.tar.gz\
    | tar --strip-components=1 -zxf -
#+END_SRC
**** DONE Commenting out things related to https.
CLOSED: [2022-07-15 Fri 23:20]
**** DONE Updating the password.
CLOSED: [2022-07-15 Fri 23:20]
Used 'htpasswd -n igi'.
'htpasswd' can be found in the 'apache2-utils' package (on Ubuntu).
**** DONE Looking for workaround to using the 'Host' http header for routing - too lazy to forge http requests using browser plugins
CLOSED: [2022-07-15 Fri 00:24]
Http request consists of several things, one of them can be one or many
headers. One of the headers carries information on what the hostname
that we tried to access was. Http request is sent to an IP address, so
the Host header can be handy. Since I'm typing the IP address in the
browser, have to find another way to let traefik know which service I
want to access.
**** DONE Adding new entrypoint for traefik dashboard. This way regular traffic will go to the portainer container and port 8080 to traefik dashboard.
CLOSED: [2022-07-15 Fri 00:24]
**** TODO Add the nextcloud service and db for nextcloud.
For that I need to create a new docker-compose stack (so it's called
in portainer settings). What needs to change compared to the first
nextcloud local demo without traefik is traefik labels, including
labels for the docker networks. Reminding myself that I had to remove
networks and https to get my local setup to work. Now I know why -
when using traefik, we need to also define the network in traefik
labels, the regular definition is not enough.
***** DONE Copying last working nextcloud setup to apps folder in raf setup's directory.
CLOSED: [2022-07-16 Sat 17:14]
***** DONE Fix the ingress for traefik (entrypoint with a dash '-' in it's name didn't work, maybe it's something with Golang's grammar? Changing dash to underscore '_', because there are other things in yaml files that have underscores in it's names) - turns out it was something else. Both dashes and underscores are ok in entrypoint names.
CLOSED: [2022-07-16 Sat 17:20]
***** DONE Create a new ingress for portainer so that nextcloud can use the default (port 80) route. It works, I think I'm getting the hang of using traefik.
CLOSED: [2022-07-16 Sat 17:23]
***** DONE Setup the network for nextcloud and it's database in the traefik way (with proper labels).
CLOSED: [2022-07-16 Sat 18:06]
****** Had a problem with whether I should route the to-database-traffic with Traefik. [[https://www.digitalocean.com/community/tutorials/how-to-use-traefik-v2-as-a-reverse-proxy-for-docker-containers-on-ubuntu-20-04][This digitalocean article]] says that it's enough to use docker networks, and to also tell traefik not to touch this container.
****** Works :)

*** TODO Add secrets
**** TODO In files first.

** Get Portainer.
* TODO Online demo using the domain.
** Getting the docker-compose file to run on the server.
*** TODO Installing docker & utils on the server.
* TODO Get certs with Traefik.
** Fake (training) cert.
** Real cert.
* TODO http to https redirect with Traefik.
* TODO Docker Swarm with a separate manager node.
** Get Swarm to Work
** Automate Reading secrets by docker swarm.

* Features Ideas:
** Use Backblaze container
** DONE Use docker compose.
   CLOSED: [2022-07-04 Mon 23:51]
#+BEGIN_SRC bash
Base version - apache

This version will use the apache image and add a mariaDB container. The volumes are set to keep your data persistent. This setup provides no ssl encryption and is intended to run behind a proxy.

Make sure to pass in values for MYSQL_ROOT_PASSWORD and MYSQL_PASSWORD variables before you run this setup.

version: '2'

volumes:
  nextcloud:
  db:

services:
  db:
    image: mariadb
    restart: always
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=
      - MYSQL_PASSWORD=
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud

  app:
    image: nextcloud
    restart: always
    ports:
      - 8080:80
    links:
      - db
    volumes:
      - nextcloud:/var/www/html
    environment:
      - MYSQL_PASSWORD=
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_HOST=db

Then run docker-compose up -d, now you can access Nextcloud at http://localhost:8080/ from your host system.

#+END_SRC

** Use Docker Secrets
*** Copied from Docker Hub Readme file for Nextcloud.
#+BEGIN_SRC bash
Docker Secrets

As an alternative to passing sensitive information via environment variables, _FILE may be appended to the previously listed environment variables, causing the initialization script to load the values for those variables from files present in the container. In particular, this can be used to load passwords from Docker secrets stored in /run/secrets/<secret_name> files. For example:

version: '3.2'

services:
  db:
    image: postgres
    restart: always
    volumes:
      - db:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB_FILE=/run/secrets/postgres_db
      - POSTGRES_USER_FILE=/run/secrets/postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    secrets:
      - postgres_db
      - postgres_password
      - postgres_user

  app:
    image: nextcloud
    restart: always
    ports:
      - 8080:80
    volumes:
      - nextcloud:/var/www/html
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB_FILE=/run/secrets/postgres_db
      - POSTGRES_USER_FILE=/run/secrets/postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - NEXTCLOUD_ADMIN_PASSWORD_FILE=/run/secrets/nextcloud_admin_password
      - NEXTCLOUD_ADMIN_USER_FILE=/run/secrets/nextcloud_admin_user
    depends_on:
      - db
    secrets:
      - nextcloud_admin_password
      - nextcloud_admin_user
      - postgres_db
      - postgres_password
      - postgres_user

volumes:
  db:
  nextcloud:

secrets:
  nextcloud_admin_password:
    file: ./nextcloud_admin_password.txt # put admin password in this file
  nextcloud_admin_user:
    file: ./nextcloud_admin_user.txt # put admin username in this file
  postgres_db:
    file: ./postgres_db.txt # put postgresql db name in this file
  postgres_password:
    file: ./postgres_password.txt # put postgresql password in this file
  postgres_user:
    file: ./postgres_user.txt # put postgresql username in this file

Currently, this is only supported for NEXTCLOUD_ADMIN_PASSWORD, NEXTCLOUD_ADMIN_USER, MYSQL_DATABASE, MYSQL_PASSWORD, MYSQL_USER, POSTGRES_DB, POSTGRES_PASSWORD, POSTGRES_USER, REDIS_HOST_PASSWORD and SMTP_PASSWORD.

If you set any group of values (i.e. all of MYSQL_DATABASE_FILE, MYSQL_USER_FILE, MYSQL_PASSWORD_FILE, MYSQL_HOST), the script will not use the corresponding group of environment variables (MYSQL_DATABASE, MYSQL_USER, MYSQL_PASSWORD, MYSQL_HOST).

#+END_SRC

** Use Traefik.
** Use Portainer.
* Extras:
** TODO Vagrant doesn't start automatically (requires choosing an interface to bridge with). Make it use wlp3s0 by default.
** [[https://stackoverflow.com/a/72599205][Link]]: Downloading contents of a git repo without creating the git repo itself (without creating .git directory and all the stuff inside it)
in my case:
#+BEGIN_SRC bash
curl -L
https://github.com/rafrasenberg/docker-traefik-portainer/archive/master.tar.gz |
tar zxf -
#+END_SRC
*** It's pretty cool, because it allows "cloning" stuff into directories already indexed by another repo.
